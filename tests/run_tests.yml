parameters:
  param : []

steps:
  - script: |
      echo "##vso[task.setvariable variable=errcount]0"
  - ${{ each p in parameters.param}}:
    - script: |
        python3 -m xmlrunner ${{ p }}.py -o ${{ p }}
        echo $(ls ${{ p }} | head -1)
        ResultFile=$(ls -t ${{ p }} | head -1)
        TestErrors=$(python3 pipeline/parse_result.py "$(System.DefaultWorkingDirectory)/${{ p }}/$ResultFile")
        ResultFiles="$(results)$(System.DefaultWorkingDirectory)/${{ p }}/$ResultFile "
        RunIDs="$(runids)$(Build.BuildNumber) "
        let TotalErrors=$TestErrors+$(errcount)
        export TotalErrors=$TotalErrors
        export ResultFiles=$ResultFiles
        export RunIDs=$RunIDs
        echo "##vso[task.setvariable variable=errcount]$TotalErrors"
        echo "##vso[task.setvariable variable=results]$ResultFiles"
        echo "##vso[task.setvariable variable=runids]$RunIDs"
      displayName: 'Run ${{ p }} tests'
      continueOnError: true
      
    - task: PublishTestResults@2
      displayName: 'Publish ${{ p }} result'
      inputs:
        testResultsFiles: '$(System.DefaultWorkingDirectory)/${{ p }}/*.xml'
        testRunTitle: ${{ p }}